version: '3.2'
services:
  cron:
    image: semawi/cron:${SEMAWI_VERSION}
    build:
      context: dockerfiles/cron
      dockerfile: Dockerfile
      args:
        - ALPINE_VERSION=${SEMAWI_ALPINE_VERSION}
    container_name: semawi-cron
    restart: unless-stopped
    depends_on:
      - semawi
      - gc2sync
    networks:
      - wiki_network
  gc2sync:
    build:
      context: dockerfiles/geocloud-sync
      dockerfile: Dockerfile
      args:
        - PYTHON_VERSION=${SEMAWI_PYTHON_VERSION}
    image: semawi/gc2sync:${SEMAWI_VERSION}
    networks:
      - wiki_network
    container_name: semawi-gc2sync
    restart: on-failure
    environment:
      - SEMAWI_GC2_BOT_USER=${SEMAWI_GC2_BOT_USER}
      - SEMAWI_GC2_BOT_PASS=${SEMAWI_GC2_BOT_PASS}
      - SEMAWI_GC2_MW_SITE=${SEMAWI_GC2_MW_SITE}
      - SEMAWI_GC2_MW_PATH=${SEMAWI_GC2_MW_PATH}
      - SEMAWI_GC2_MW_SCHEME=${SEMAWI_GC2_MW_SCHEME}
      - SEMAWI_GC2_URL=${SEMAWI_GC2_URL}
    depends_on:
      - semawi
    hostname: semawi-gc2sync
    restart: unless-stopped
  semawi:
    build:
      context: dockerfiles/semawi
      dockerfile: Dockerfile
      args:
        - SEMAWI_MW_MINOR_VERSION=${SEMAWI_MW_MINOR_VERSION}
        - SEMAWI_MW_PATCH_VERSION=${SEMAWI_MW_PATCH_VERSION}
        - SMW_VERSION=${SEMAWI_SMW_VERSION}
        - SRF_VERSION=${SEMAWI_SRF_VERSION}
        - SFS_VERSION=${SEMAWI_SFS_VERSION}
        - DEBIAN_VERSION=${SEMAWI_DEBIAN_VERSION}
    image: semawi/mediawiki:${SEMAWI_VERSION}
    ports:
      - target: 80
        published: ${SEMAWI_PORT}
        protocol: tcp
        mode: host
    volumes:
      - semawi-images:/var/www/wiki/images/
      - ./${SEMAWI_LOGO}:/var/www/wiki/resources/assets/semawilogo.png
      - /srv/semawi/freetds.conf:/etc/freetds/freetds.conf
      - /srv/semawi/odbcinst.ini:/etc/odbcinst.ini
      - /srv/semawi/odbc.ini:/etc/odbc.ini
    networks:
      - wiki_network
    container_name: semawi-mediawiki
    restart: on-failure
    environment:
      - SEMAWI_WGSERVER=${SEMAWI_WGSERVER}
      - SEMAWI_SITENAME=${SEMAWI_SITENAME}
      - SEMAWI_WGSECRETKEY=${SEMAWI_WGSECRETKEY}
      - SEMAWI_WGUPGRADEKEY=${SEMAWI_WGUPGRADEKEY}
      - SEMAWI_MAXFILESIZE=${SEMAWI_MAXFILESIZE}
      - SEMAWI_PHP_MEM_LIMIT=${SEMAWI_PHP_MEM_LIMIT}
    depends_on:
      - wikidb
    hostname: semawi-mediawiki
    restart: unless-stopped
  wikidb:
    image: semawi/mysql:${SEMAWI_VERSION}
    build:
      context: dockerfiles/mysql
      dockerfile: Dockerfile
      args:
        - MYSQL_VERSION=${SEMAWI_MYSQL_VERSION}
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=wiki
      - MYSQL_USER=wiki
      - MYSQL_PASSWORD=wiki
    networks:
      - wiki_network
    container_name: semawi-mysql
    hostname: semawi-mysql
    restart: unless-stopped

networks:
  wiki_network:
    driver: bridge

volumes:
  semawi-images:
    external: false
